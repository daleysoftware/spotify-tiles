<!doctype html>
<html>
    <head>
        <title>Spotify Tiles</title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <style type="text/css">
            body, html {
                height: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            #login {
                text-align: center;
                position: absolute;
                top: 50%;
                height: 20%;
                width: 100%;
                margin-top: -10%;
            }
            #loggedin {
                display: none;
            }
            .text-overflow {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                width: 500px;
            }
        </style>
    </head>

    <body>
        <div id="login">
            <h1>Sign In to Spotify Tiles</h1>
            <br/>
            <p><a href="/login" class="btn btn-primary">Log in with Spotify</a></p>
        </div>
        <div class="container">
            <div id="loggedin">
                <!-- TODO replace with tiles, etc. -->
                <div id="user-profile"></div>
            </div>
        </div>

        <script id="user-profile-template" type="text/x-handlebars-template">
            <h1>Logged in as {{display_name}}</h1>
            <div class="media">
                <div class="pull-left">
                    <img class="media-object" width="150" src="{{images.0.url}}" />
                </div>
                <div class="media-body">
                    <dl class="dl-horizontal">
                        <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
                        <dt>Id</dt><dd>{{id}}</dd>
                        <dt>Email</dt><dd>{{email}}</dd>
                        <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
                        <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
                        <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                        <dt>Country</dt><dd>{{country}}</dd>
                    </dl>
                </div>
            </div>
        </script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script>
            (function() {
                function getHashParams() {
                    var hashParams = {};
                    var e, r = /([^&;=]+)=?([^&;]*)/g,
                        q = window.location.hash.substring(1);
                    while (e = r.exec(q)) {
                        hashParams[e[1]] = decodeURIComponent(e[2]);
                    }
                    return hashParams;
                }

                var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                        userProfileTemplate = Handlebars.compile(userProfileSource),
                        userProfilePlaceholder = document.getElementById('user-profile');

                var params = getHashParams();

                var access_token = params.access_token
                        refresh_token = params.refresh_token;

                if (access_token) {
                    $('#login').hide();
                    $.ajax({
                        // TODO GET tiles instead of user info. Create custom call in app.js.
                        url: 'https://api.spotify.com/v1/me',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function(response) {
                            userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                            $('#loggedin').show();
                        }
                    });
                } else {
                    $('#login').show();
                    $('#loggedin').hide();
                }
            })();
        </script>
</html>
